- name: Remove Ubuntu Junk
  hosts: z
  tasks:
  - name: remove ubuntu motd spam
    become: true
    file:
      path: "/etc/update-motd.d/{{ item }}"
      state: absent
    loop:
      - 80-livepatch
      - 95-hwe-eol
      - 10-help-text
      - 50-motd-news
      - 85-fwupd
      - 91-release-upgrade
    when: ansible_distribution == 'Ubuntu'

- name: Bulk Upgrayyed
  hosts: z
  # strategy: free
  become: yes
  become_user: root

  tasks:

  - name: apt-get autoremove equivalent
    apt:
      autoremove: yes
      autoclean: yes

  - name: apt-get update equivalent
    apt:
      update_cache: yes
      cache_valid_time: 3600

  - name: Upgrade
    apt:
      upgrade: full

  - name: apt-get autoremove equivalent
    apt:
      autoremove: yes
      autoclean: yes

  # - name: Purge residual kernel packages
  #    shell: apt-get remove -y --purge $(dpkg -l | grep "^rc\s*linux-image-" | awk '{print $2}' | tr '\-n' ' ')
  #   register: apt_result
  #   changed_when: "'packages will be REMOVED' in apt_result.stdout"

  - name: apt-get autoremove equivalent
    apt:
      autoremove: yes
      autoclean: yes

- name: Update my dotfiles everywhere
  hosts: z

  tasks:

  - name: Fetch my stuff
    shell: cd myDotfiles && GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519_github" git pull
    async: 45
    poll: 5
    register: pull_result
    changed_when: pull_result.stdout is not search('Already up to date.')

  - debug:
      var: pull_result

- name: Update my emacs packages everywhere
  hosts: z
  tasks:

  - name: Update emacs
    shell: emacs --batch -l ~/.emacs.d/init.el -f auto-package-update-now
    register: run_result
    changed_when: run_result.stdout is search('Parsing tar file')

  - debug:
      var: run_result
